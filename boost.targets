<!--
***********************************************************************************************

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your projects from the command-line or the IDE.

Copyright Eugene Sadovoi (C) 
***********************************************************************************************
-->

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!--
  ///////////////////////////////////////////////////////////
  // Defaults
  ///////////////////////////////////////////////////////////-->

  
  <!--
  ///////////////////////////////////////////////////////////
  // UI Configuration
  ///////////////////////////////////////////////////////////-->
  <ItemGroup>
    <PropertyPageSchema Include="$(ProjectDir)boost.xml" >
      <Context>Project</Context>
      <Name>Boost</Name>
      <GetXmlConfig>TrimFolderEnd=true;SmartQuotes=true;FullPath=true;</GetXmlConfig>
    </PropertyPageSchema>
    
    <PropertyPageSchema Include="$(ProjectDir)cl.xml" >
      <Name>cxxFlags</Name>
      <SwitchPrefix>cxxflags=&#34;</SwitchPrefix>
      <SwitchSuffix>&#34;</SwitchSuffix>
      <GetXmlConfig>TrimFolderEnd=true;SmartQuotes=true;FullPath=true;Quote=&#39;</GetXmlConfig>
    </PropertyPageSchema>
    
    <PropertyPageSchema Include="$(ProjectDir)link.xml" >
      <Name>LinkFlags</Name>
      <SwitchPrefix>linkflags=&#34;</SwitchPrefix>
      <SwitchSuffix>&#34;</SwitchSuffix>
      <GetXmlConfig>TrimFolderEnd=true;SmartQuotes=true;FullPath=true;Quote=&#39;</GetXmlConfig>
    </PropertyPageSchema>

    <ProjectTools Include="%(PropertyPageSchema.Name)" />
  </ItemGroup>
  
  
  <!--
  ///////////////////////////////////////////////////////////
  // Resolve Boost root dir
  ///////////////////////////////////////////////////////////-->
  <Target Name="BoostRoot" Condition="'$(BoostRoot)'==''" Returns="BoostRoot">

    <PropertyGroup Condition="'$(BoostDir)'==''">
      <JamrootDir>$(ProjectDir)*/Jamroot</JamrootDir>
      <BoostRoot>$([System.IO.Path]::GetDirectoryName($(JamrootDir)).TrimEnd($([System.IO.Path]::DirectorySeparatorChar)))</BoostRoot>
      <BoostRoot Label="Check if BOOST_ROOT set"             >$(BOOST_ROOT.TrimEnd($([System.IO.Path]::DirectorySeparatorChar)))</BoostRoot>
      <BoostRoot Label="Check if Jamroot file in local dir"
                Condition="'$(BoostDir)'=='' And 
                           Exists('$(ProjectDir)Jamroot')">$(ProjectDir.TrimEnd($([System.IO.Path]::DirectorySeparatorChar)))</BoostRoot>
      <BoostRoot Label="Check if Jamroot file in ./.. dir"
                Condition="'$(BoostDir)'=='' And 
                           Exists('$(ProjectDir)..\Jamroot')">$([System.IO.Path]::GetFullPath("$(ProjectDir)..\").TrimEnd($([System.IO.Path]::DirectorySeparatorChar)))</BoostRoot>
      <BoostRoot Label="Check if Jamroot file in ./../.. dir"
              Condition="'$(BoostDir)'=='' And 
                           Exists('$(ProjectDir)..\..\Jamroot')">$([System.IO.Path]::GetFullPath("$(ProjectDir)..\..\").TrimEnd($([System.IO.Path]::DirectorySeparatorChar)))</BoostRoot>
    </PropertyGroup>

    <PropertyGroup Condition="'$(BoostDir)'!=''">
      <BoostRoot>$([System.IO.Path]::GetFullPath("$(BoostDir)").TrimEnd($([System.IO.Path]::DirectorySeparatorChar)))</BoostRoot>
    </PropertyGroup>
    
    <Error Condition="'$(BoostRoot)'==''"              Text="Boost Library not found."  ContinueOnError="false" />
    <Error Condition="!Exists('$(BoostRoot)\Jamroot')" Text="Boost library is missing. Did you set BOOST_ROOT environment variable?" ContinueOnError="false" />
    
    <Message Text="Boost root dir: &#34;$(BoostRoot)&#34;"  Importance="normal"/>
  </Target>


  <!--
  ///////////////////////////////////////////////////////////
  // Disambiguate directories
  ///////////////////////////////////////////////////////////-->
  <Target Name="GetDirs" Returns="dirs-options">
    <ItemGroup>
      <dirs-options Condition="'$(IntDir)'!=''" 
                    Include="--build-dir=&#34;$([System.IO.Path]::GetFullPath('$(IntDir)').TrimEnd($([System.IO.Path]::DirectorySeparatorChar)))&#34;" />
      <dirs-options Condition="'$(OutDir)'!=''" 
                    Include="--stagedir=&#34;$([System.IO.Path]::GetFullPath('$(OutDir)').TrimEnd($([System.IO.Path]::DirectorySeparatorChar)))&#34;" />
      <dirs-options Condition="'$(OutDir)'!='' And '$(BoostDeployment)'=='Install'" 
                    Include="--prefix=&#34;$([System.IO.Path]::GetFullPath('$(OutDir)').TrimEnd($([System.IO.Path]::DirectorySeparatorChar)))&#34;" />
    </ItemGroup>
  </Target>


  <!--
  ///////////////////////////////////////////////////////////
  // Prepare command line options for build command
  ///////////////////////////////////////////////////////////-->
  <Target Name="PrepareForBoostBuild" Label="Prepare boost build options" Returns="@(boost-options)" DependsOnTargets="GetDirs;" >
    <MSBuild Targets="GetXmlConfig" Projects="$(MSBuildProjectFullPath)" 
             Properties="PropertyPageSchema=%(PropertyPageSchema.Identity);Name=%(PropertyPageSchema.Name);%(PropertyPageSchema.GetXmlConfig)" >
      <Output ItemName="options-%(PropertyPageSchema.Name)" TaskParameter="TargetOutputs"/>
    </MSBuild>

    <ItemGroup Label="Build Settings">
      <boost-options Condition="'$(PlatformToolset)'  ==''" Include="toolset=msvc" />
      <boost-options Condition="'$(PlatformToolset)'  !=''" Include="$([System.String]::Format('toolset=msvc-{0}.{1}', $(PlatformToolset.Substring(1, 2)), $(PlatformToolset.Substring(3,1))))" />
      <boost-options Condition="'@(dirs-options)'     !=''" Include="%(dirs-options.Identity)" />
      <boost-options Condition="'@(options-%(PropertyPageSchema.Name))'!=''"  Include="%(PropertyPageSchema.SwitchPrefix);@(options-%(PropertyPageSchema.Name), ' ');%(PropertyPageSchema.SwitchSuffix)" />
      <boost-options Condition="'$(AdditionalOptions)'!=''"                   Include="$(AdditionalOptions)" />
    </ItemGroup>
  </Target>


  <!--
  ///////////////////////////////////////////////////////////
  // Build Jamfile Build Tool "B2.EXE"
  ///////////////////////////////////////////////////////////-->
  <ItemGroup Label="Engine source files">
    <EngineSourceFiles Include="$(BoostDir)\tools\build\src\engine\*.h" />
    <EngineSourceFiles Include="$(BoostDir)\tools\build\src\engine\*.c" />
  </ItemGroup>
  
  <Target Name="BuildJamTool" Label="Building BJAM engine"
          Inputs="@(EngineSourceFiles)" Outputs="$(BoostRoot)\b2.exe" DependsOnTargets="BoostRoot;" >
    <Error ContinueOnError="false" Text="Engine source files are missing, did you update submodules?" Condition="@(EngineSourceFiles)==''" />
    
    <Message Text="Building Engine..." Importance="normal" />
    <Exec Command="call build.bat" WorkingDirectory="$(BoostRoot)\tools\build\src\engine\" EnvironmentVariables="VS_UNICODE_OUTPUT=" />
    
    <ItemGroup Label="List and copy all built exe files" >
      <BJamTools Include="$(BoostDir)\tools\build\src\engine\bin.ntx86\*.exe" Condition="Exists('$(BoostDir)\tools\build\src\engine\bin.ntx86')" />
      <BJamTools Include="$(BoostDir)\tools\build\src\engine\bin.ntx86_64\*.exe" Condition="Exists('$(BoostDir)\tools\build\src\engine\bin.ntx86_64')" />
    </ItemGroup>
    <Copy SourceFiles="@(BJamTools)" DestinationFolder="$(BoostRoot)\" UseHardlinksIfPossible="true" />
  </Target>


  <!--
  ///////////////////////////////////////////////////////////
  // Rebuild Boost Includes
  ///////////////////////////////////////////////////////////-->
  <Target Name="BoostHeaders"  Condition="!Exists('$(BoostRoot)\boost')" DependsOnTargets="GetDirs;BoostRoot;BuildJamTool;" >
    <Exec Command="b2.exe toolset=msvc headers @(dirs-options, ' ')" WorkingDirectory="$(BoostRoot)\" EnvironmentVariables="VS_UNICODE_OUTPUT=" />
  </Target>


    <!--
    ///////////////////////////////////////////////////////////
    // BUILD TARGET
    /////////////////////////////////////////////////////////// -->
  <Target Name="Build" DependsOnTargets="BoostRoot;PrepareForBoostBuild;BuildJamTool;BoostHeaders;" >
  <!--
    <Message Text="boost-options : @(boost-options, ' ')"  Importance="high"/>
    <Message Text="env-vars : @(env-vars, ' ')" Condition=""  Importance="high"/>
    <Message Text="IncludeDir : $(IncludeDir)" Condition=""  Importance="high"/>
  -->
    <Exec Command="b2.exe @(boost-options, ' ')" WorkingDirectory="$(BoostRoot)\" EnvironmentVariables="VS_UNICODE_OUTPUT=" />
  </Target>

  <!--
    ///////////////////////////////////////////////////////////
    // REBUILD TARGET
    /////////////////////////////////////////////////////////// -->
  <Target Name="Rebuild" DependsOnTargets="BoostRoot;PrepareForBoostBuild;BuildJamTool;BoostHeaders;">
    <Exec Command="b2.exe @(boost-options, ' ') -a" WorkingDirectory="$(BoostRoot)\" EnvironmentVariables="VS_UNICODE_OUTPUT=" />
  </Target>


  <!--
    ///////////////////////////////////////////////////////////
    // CLEAN TARGET
    /////////////////////////////////////////////////////////// -->
  <Target Name="Clean" DependsOnTargets="GetDirs;BuildJamTool;" >
    <RemoveDir Directories="$(IntDir)\Boost\"   ContinueOnError="true" />
    <RemoveDir Directories="$(OutDir)\lib\"     ContinueOnError="true" />
    <RemoveDir Directories="$(OutDir)\bin\"     ContinueOnError="true" />
    <RemoveDir Directories="$(OutDir)\include\" ContinueOnError="true" />
    <!--<Exec Command="b2.exe toolset=msvc @(dirs-options, ' ') -clean"  WorkingDirectory="$(BoostRoot)\" EnvironmentVariables="VS_UNICODE_OUTPUT=" IgnoreExitCode="true" />-->
  </Target>

 
</Project>